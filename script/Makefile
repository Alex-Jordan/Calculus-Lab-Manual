## ********************************************************************* ##
## Copyright 2015                                                        ##
## Alex Jordan                                                           ##
##                                                                       ##
## This file is part of the PCC Calculus Lab Manual                      ##
##                                                                       ##
## PCCCLM is free software: you can redistribute it and/or modify        ##
## it under the terms of the Creative Commons BY-SA License              ##
##                                                                       ##
## PCCCLM is distributed in the hope that it will be useful,             ##
## but WITHOUT ANY WARRANTY; without even the implied warranty of        ##
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         ##
## CC BY-SA License for more details.                                    ##
##                                                                       ##
## ********************************************************************* ##

####################
# DO NOT EDIT THIS FILE
#######################

#   1) Do make a copy of Makefile.paths.original
#      as Makefile.paths
#   2) Edit Makefile.paths as directed there
#   3) This file (Makefile) and Makefile.paths.original
#      are managed by revision control and edits will conflict
#   4) See updated history in Makefile.paths.original
#      for changes, or follow the revision control history

##############
# Introduction
##############

# This is not a "true" makefile, since it does not
# operate on dependencies.  It is more of a shell
# script, sharing common configurations

######################
# System Prerequisites
######################

#   install         (system tool to make directories)
#   xsltproc        (xml/xsl text processor)
#   xmllint         (only to check source against DTD)
#   <helpers>       (PDF viewer, web browser, pager, Sage executable, etc)

#####
# Use
#####

#	A) Set default directory to be the location of this file
#	B) At command line:  make solutions  (and employ targets)

# The included file contains customized versions
# of locations of the principal components of this
# project and names of various helper executables
include Makefile.paths

# These paths are subdirectories of
# the Mathbook XML distribution
# MBUSR is where extension files get copied
# so relative paths work properly
# MBSCRIPT = $(MB)/script
MBXSL = $(MB)/xsl
MBUSR = $(MB)/user
WWDTD = $(WWMBX)/schema/dtd
WWXSL = $(WWMBX)/xsl

# These are source and custom XSL subdirectories
# for the CLM repository
SRC = $(CLM)/src
XSL = $(CLM)/xsl

# These paths are subdirectories of
# a scratch directory
PGOUT      = $(SCRATCH)/pg
HTMLOUT    = $(SCRATCH)/html
SROUT    = $(SCRATCH)/screenreader
PRINTOUT     = $(SCRATCH)/print
COLOROUT     = $(SCRATCH)/printcolor
SPDF     = $(SCRATCH)/screenpdf

###########
# Utilities
###########

# Verify Source integrity
#   Leaves "dtderrors.txt" in SCRATCH
#   can then grep on, eg
#     "element XXX:"
#     "does not follow"
#     "Element XXXX content does not follow"
#     "No declaration for"
#   Automatically invokes the "less" pager, could configure as $(PAGER)
check-mini:
	install -d $(SCRATCH)
	-rm $(SCRATCH)/dtderrors.*
	-xmllint --xinclude --noout --dtdvalid $(WWDTD)/webwork.dtd $(WWMBX)/examples/minimal/mini.xml 2> $(SCRATCH)/dtderrors.txt
	less $(SCRATCH)/dtderrors.txt

##########
## Builds
##########

html:
	install -d $(HTMLOUT) $(MBUSR)
	-rm $(HTMLOUT)/*.html
	cd $(HTMLOUT); \
	xsltproc -xinclude $(XSL)/clm-html.xsl $(SRC)/clm.xml
	perl -pi -e 's/Activity .1 //g' $(HTMLOUT)/supplemental-solutions.html
	perl -pi -e 's/<span class="type">Activity<\/span><span class="codenumber">.1<\/span>//g' $(HTMLOUT)/supplemental-solutions.html
	perl -pi -e 's/<\/div><\/main>/<footer><a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/"><img alt="Creative Commons License" style="border-width:0" src="https:\/\/i\.creativecommons\.org\/l\/by-sa\/4\.0\/88x31\.png" \/><\/a><br \/>This work is licensed under a <a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/">Creative Commons Attribution-ShareAlike 4\.0 International License<\/a>\.<\/footer><\/div><\/main>/g' $(HTMLOUT)/*.html
	perl -pi -e 's/<footer><a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/"><img alt="Creative Commons License" style="border-width:0" src="https:\/\/i\.creativecommons\.org\/l\/by-sa\/4\.0\/88x31\.png" \/><\/a><br \/>This work is licensed under a <a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/">Creative Commons Attribution-ShareAlike 4\.0 International License<\/a>\.<\/footer>//g' $(HTMLOUT)/colophon-1.html
	perl -pi -e 's/Activity \.\.. //g' $(HTMLOUT)/to-all.html
	perl -pi -e 's/<span class="type">Activity<\/span>//g' $(HTMLOUT)/to-all.html
	perl -pi -e 's/<span class="codenumber">\.\..<\/span>//g' $(HTMLOUT)/to-all.html
	perl -pi -e 's/elevation<span class="hidden-knowl-wrapper"><a knowl="" class="id-ref" refid="hk-fn-1" id="fn-1"><sup> 1 <\/sup>/elevation<span class="hidden-knowl-wrapper" style="margin-left: 0; "><a knowl="" class="id-ref" refid="hk-fn-1" id="fn-1"><sup>1<\/sup>/g' $(HTMLOUT)/section-velocity.html
	perl -pi -e 's/>(Limit Law [AR][0-9]*) </>\1</g' $(HTMLOUT)/*.html
	perl -pi -e 's/<div class="sidebyside" id="sidebyside-curves">/<div class="sidebyside" id="sidebyside-curves" style="text-align: center;">/g' $(HTMLOUT)/section-graphical-features-from-derivatives.html
	perl -pi -e 's/^<div class="svg-and-links">/<div style="width:90%;" class="svg-and-links">/g' $(HTMLOUT)/functions-derivatives-antiderivatives-supplementary-exercises.html
	perl -pi -e 's/<div class="sidebyside" id="figure-seven-curves">/<div class="sidebyside" id="figure-seven-curves" style="text-align: center;">/g' $(HTMLOUT)/functions-derivatives-antiderivatives-supplementary-exercises.html
	perl -pi -e 's/<figure class="figure-like" id="figure-inflection-points"><div class="svg-and-links">/<figure class="figure-like" id="figure-inflection-points"><div style="width:75%; min-width:220px" class="svg-and-links">/g' $(HTMLOUT)/section-graphical-derivatives.html
	perl -pi -e 's/width:10%;min-width:[0-9]*px;/width:23%;min-width:100px;/g' $(HTMLOUT)/section-graphical-features-from-derivatives.html

screenreader:
	install -d $(SROUT) $(MBUSR)
	-rm $(SROUT)/*.html
	cd $(SROUT); \
	xsltproc -xinclude $(XSL)/clm-html.xsl $(SRC)/clm.xml
	perl -pi -e 's/Activity .1 //g' $(SROUT)/supplemental-solutions.html
	perl -pi -e 's/<span class="type">Activity<\/span><span class="codenumber">.1<\/span>//g' $(SROUT)/supplemental-solutions.html
	perl -pi -e 's/<\/div><\/main>/<footer><a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/"><img alt="Creative Commons License" style="border-width:0" src="https:\/\/i\.creativecommons\.org\/l\/by-sa\/4\.0\/88x31\.png" \/><\/a><br \/>This work is licensed under a <a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/">Creative Commons Attribution-ShareAlike 4\.0 International License<\/a>\.<\/footer><\/div><\/main>/g' $(SROUT)/*.html
	perl -pi -e 's/<footer><a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/"><img alt="Creative Commons License" style="border-width:0" src="https:\/\/i\.creativecommons\.org\/l\/by-sa\/4\.0\/88x31\.png" \/><\/a><br \/>This work is licensed under a <a rel="license" href="http:\/\/creativecommons\.org\/licenses\/by-sa\/4\.0\/">Creative Commons Attribution-ShareAlike 4\.0 International License<\/a>\.<\/footer>//g' $(SROUT)/colophon-1.html
	perl -pi -e 's/Activity \.\.. //g' $(SROUT)/to-all.html
	perl -pi -e 's/<span class="type">Activity<\/span>//g' $(SROUT)/to-all.html
	perl -pi -e 's/<span class="codenumber">\.\..<\/span>//g' $(SROUT)/to-all.html
	perl -pi -e 's/elevation<span class="hidden-knowl-wrapper"><a knowl="" class="id-ref" refid="hk-fn-1" id="fn-1"><sup> 1 <\/sup>/elevation<span class="hidden-knowl-wrapper" style="margin-left: 0; "><a knowl="" class="id-ref" refid="hk-fn-1" id="fn-1"><sup>1<\/sup>/g' $(SROUT)/section-velocity.html
	perl -pi -e 's/>(Limit Law [AR][0-9]*) </>\1</g' $(SROUT)/*.html
	perl -pi -e 's/<div class="sidebyside" id="sidebyside-curves">/<div class="sidebyside" id="sidebyside-curves" style="text-align: center;">/g' $(SROUT)/section-graphical-features-from-derivatives.html
	perl -pi -e 's/^<div class="svg-and-links">/<div style="width:90%;" class="svg-and-links">/g' $(SROUT)/functions-derivatives-antiderivatives-supplementary-exercises.html
	perl -pi -e 's/<div class="sidebyside" id="figure-seven-curves">/<div class="sidebyside" id="figure-seven-curves" style="text-align: center;">/g' $(SROUT)/functions-derivatives-antiderivatives-supplementary-exercises.html
	perl -pi -e 's/<figure class="figure-like" id="figure-inflection-points"><div class="svg-and-links">/<figure class="figure-like" id="figure-inflection-points"><div style="width:75%; min-width:220px" class="svg-and-links">/g' $(SROUT)/section-graphical-derivatives.html
	perl -pi -e 's/width:10%;min-width:[0-9]*px;/width:23%;min-width:100px;/g' $(SROUT)/section-graphical-features-from-derivatives.html
	perl -pi -e 's/<a (knowl=[^>]+)>/<a href="" \1>/g' $(SROUT)/*.html
	perl -pi -e 's/<body([^>]+)>/<body \1><a class="skip-links" accesskey="C" href="#content">Skip to Main Content<\/a>/g' $(SROUT)/*.html
	perl -pi -e 's/\?config=TeX-AMS-MML_HTMLorMML-full//g' $(SROUT)/*.html
	perl -pi -e 's/MathJax.Hub.Config\({/MathJax.Hub.Config({\n    extensions: ["tex2jax.js"],\n    jax: ["input\/TeX", "output\/NativeMML"],/g' $(SROUT)/*.html
	perl -pi -e 's/"images\//"..\/images\//g' $(SROUT)/*.html
